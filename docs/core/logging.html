<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Logging - Game Engine Docs</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../core.html"><strong aria-hidden="true">1.</strong> Core</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../core/coroutines.html"><strong aria-hidden="true">1.1.</strong> Coroutines</a></li><li class="chapter-item expanded "><a href="../core/memory-management.html"><strong aria-hidden="true">1.2.</strong> Memory Management</a></li><li class="chapter-item expanded "><a href="../core/logging.html" class="active"><strong aria-hidden="true">1.3.</strong> Logging</a></li></ol></li><li class="chapter-item expanded "><a href="../api-ref.html"><strong aria-hidden="true">2.</strong> API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../api/system.html"><strong aria-hidden="true">2.1.</strong> System</a></li><li class="chapter-item expanded "><a href="../api/time.html"><strong aria-hidden="true">2.2.</strong> Time</a></li><li class="chapter-item expanded "><a href="../api/audio.html"><strong aria-hidden="true">2.3.</strong> Audio</a></li></ol></li><li class="chapter-item expanded "><a href="../api/system/exit.html">ㅤ</a></li><li class="chapter-item expanded affix "><a href="../api/system/sleep.html">ㅤ</a></li><li class="chapter-item expanded affix "><a href="../api/time/duration.html">ㅤ</a></li><li class="chapter-item expanded affix "><a href="../api/time/duration/constructor.html">ㅤ</a></li><li class="chapter-item expanded affix "><a href="../api/audio/playsound.html">ㅤ</a></li><li class="chapter-item expanded affix "><a href="../api/audio/playmusic.html">ㅤ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Game Engine Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="logging"><a class="header" href="#logging">Logging</a></h1>
<p>I would like to create a more versatile logging system than the default <code>std::cout</code> and <code>printf</code>, which means I need to be able to capture and/or redirect the output, add colours and formats, and support different logging levels, and be thread-safe. It will also need different backends to support Linux and Windows.</p>
<h2 id="the-interface"><a class="header" href="#the-interface">The Interface</a></h2>
<p>The interface should be as straightforward as possible, with all functions inside the namespace <code>Log</code>:</p>
<pre><code class="language-C++">namespace Log
{
	enum Channel
	{
		Fatal, Error, Warn, Info, Debug, Trace
	};

	enum Flags
	{
		CanCapture = 1,
		StdOut = 2,
		ShowTime = 4,
		// other options here
		Default = CanCapture | StdOut
	};

	struct LogCapture
	{
		...
	};

	LogCapture* capture();

	void fatal(const std::string&amp; message, const Flags&amp; flags = Flags::Default);
	void fatal(const char* message, const Flags&amp; flags = Flags::Default);
	void error(const std::string&amp; message, const Flags&amp; flags = Flags::Default);
	void error(const char* message, const Flags&amp; flags = Flags::Default);
	void warn(const std::string&amp; message, const Flags&amp; flags = Flags::Default);
	void warn(const char* message, const Flags&amp; flags = Flags::Default);
	void info(const std::string&amp; message, const Flags&amp; flags = Flags::Default);
	void info(const char* message, const Flags&amp; flags = Flags::Default);
	void debug(const std::string&amp; message, const Flags&amp; flags = Flags::Default);
	void debug(const char* message, const Flags&amp; flags = Flags::Default);
	void trace(const std::string&amp; message, const Flags&amp; flags = Flags::Default);
	void trace(const char* message, const Flags&amp; flags = Flags::Default);
}
</code></pre>
<p>Now we have a way to send a message to any logging level, and we can internally disable <code>debug</code> and <code>trace</code> levels. We also have some flags that let us change how and where the message is sent. Now on to <code>LogCapture</code>:</p>
<pre><code class="language-C++">namespace Log
{
	...
	
	struct LogCapture
	{
		void stop();
		void pause();
		void resume();
		void (*callback)(const std::string&amp; message, const Flags&amp; flags, const Channel&amp; channel) = nullptr;
		void capture(const std::string&amp; message, const Flags&amp; flags, const Channel&amp; channel);
	};

	LogCapture* capture();

	...
}
</code></pre>
<p>The <code>LogCapture</code> struct simply acts as a passthrough to a user callback, with a stop function to disable the capture and destroy it, as well as pause and resume to stop without destroying the capture.</p>
<h2 id="the-backend"><a class="header" href="#the-backend">The Backend</a></h2>
<p>Linux and Windows both have separate implementations, so they will be shown separately. Below is the code the two have in common:</p>
<pre><code class="language-C++">
std::mutex log_mux;
std::vector&lt;Log::LogCapture*&gt; captures;

Log::LogCapture* Log::capture()
{
	captures.push_back(new Log::LogCapture());
	return captures.back();
}

void handle_capture(const std::string&amp; message, const Log::Flags&amp; flags, const Log::Channel&amp; channel)
{
	for(auto _capture : captures)
	{
		_capture-&gt;capture(message, flags, channel);
	}
}

std::string get_channel_fmt(const Log::Channel&amp; channel)
{
	switch(channel)
	{
		case Fatal: return &quot;[Fatal] &quot;;
		case Error: return &quot;[Error] &quot;;
		case Warn:  return &quot;[Warn]  &quot;;
		case Info:  return &quot;[Info]  &quot;;
		case Debug: return &quot;[Debug] &quot;;
		case Trace: return &quot;[Trace] &quot;;
		default: break;
	}
	// error
}

std::string get_time_fmt()
{
	auto now = std::chrono::system_clock::to_time_t(std::chrono::system_clock::now());
	std::string s(50, '\0');
	uint64_t size = std::strftime(&amp;s[0], s.size(), &quot;%d/%m/%Y %H:%M:%S&quot;, std::localtime(&amp;now));
	s.resize(size);
	return s;
}

void log(const Log::Channel&amp; channel, const std::string&amp; message, const Log::Flags&amp; flags);
void log(const Log::Channel&amp; channel, const char* message, const Log::Flags&amp; flags);

void Log::fatal(const std::string&amp; message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Fatal, message, flags);
}

void Log::fatal(const char* message, const Flags&amp; flags)
{
	log(Channel::Fatal, message, flags);
}

void Log::error(const std::string&amp; message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Error, message, flags);
}

void Log::error(const char* message, const Log::Flags&amp; flags)
{
	log(Channel::Error, message, flags);
}

void Log::warn(const std::string&amp; message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Warn, message, flags);
}

void Log::warn(const char* message, const Log::Flags&amp; flags)
{
	log(Channel::Warn, message, flags);
}

void Log::info(const std::string&amp; message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Info, message, flags);
}

void Log::info(const char* message, const Log::Flags&amp; flags)
{
	log(Channel::Info, message, flags);
}

void Log::debug(const std::string&amp; message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Debug, message, flags);
}

void Log::debug(const char* message, const Log::Flags&amp; flags)
{
	log(Channel::Debug, message, flags);
}

void Log::trace(const std::string&amp; message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Trace, message, flags);
}

void Log::trace(const char* message, const Log::Flags&amp; flags)
{
	log(Log::Channel::Trace, message, flags);
}
</code></pre>
<p>Linux:</p>
<pre><code class="language-C++">std::string get_colour_fmt(const Log::Channel&amp; channel)
{
	switch(channel)
	{
		case Fatal: return &quot;\033[38;5;0;48;5;9m&quot;;
		case Error: return &quot;\033[38;5;9;48;5;0m&quot;;
	    case Warn:  return &quot;\033[38;5;11;48;5;0m&quot;;
	    case Info:  return &quot;\033[38;5;10;48;5;0m&quot;;
	    case Debug: return &quot;\033[38;5;12;48;5;0m&quot;;
	    case Trace: return &quot;\033[38;5;8;48;5;0m&quot;;
		default: break;
	}
	// error
}

void log(const Log::Channel&amp; channel, const std::string&amp; message, const Log::Flags&amp; flags)
{
	std::string msg = get_colour_fmt(channel);
	if(flags &amp; Log::Flags::ShowTime) msg = get_time_fmt() + &quot; &quot;;
	msg += get_channel_fmt(channel);
	msg += message;
	log_mux.lock();
	if(flags &amp; Log::Flags::StdOut)
	{
		std::cout &lt;&lt; message &lt;&lt; &quot;\n&quot;;
	}
	if(flags &amp; Log::Flags::CanCapture)
	{
		handle_capture(message, flags, channel);
	}
	log_mux.unlock();
}

void log(const Log::Channel&amp; channel, const char* message, const Log::Flags&amp; flags)
{
	std::string msg = message;
	log(channel, msg, flags);
}
</code></pre>
<p>Windows:</p>
<pre><code class="language-C++">uint8_t get_colour_fmt(const Log::Channel&amp; channel)
{
	switch(channel)
	{
		case Fatal: return 64;
		case Error: return 4;
		case Warn:  return 6;
		case Info:  return 2;
		case Debug: return 1;
		case Trace: return 8;
		default: break;
	}
	// error
}

void log(const Log::Channel&amp; channel, const std::string&amp; message, const Log::Flags&amp; flags)
{
	std::string msg = &quot;&quot;;
	if(flags &amp; Log::Flags::ShowTime) msg = get_time_fmt() + &quot; &quot;;
	msg += get_channel_fmt(channel);
	msg += message;
	log_mux.lock();
	if(flags &amp; Log::Flags::StdOut)
	{
		msg += &quot;\n&quot;;
		HANDLE h_console = GetStdHandle(STD_OUTPUT_HANDLE);
		SetConsoleTextAttribute(h_console, get_colour_fmt(channel));
		LPDWORD num_written = 0;
		WriteConsoleA(h_console, msg.c_str(), (DWORD)msg.size(), num_written, 0);
	}
	if(flags &amp; Log::Flags::CanCapture)
	{
		handle_capture(message, flags, channel);
	}
	log_mux.unlock();
}

void log(const Log::Channel&amp; channel, const char* message, const Log::Flags&amp; flags)
{
	std::string msg = message;
	log(channel, msg, flags);
}
</code></pre>
<p>In the Linux implementation, we use escape codes to apply the colour to the message, and then fall back to <code>std::cout</code> to actually log the message. In the Windows implementation, we use the Windows API to set the console colour and then log the message.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../core/memory-management.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../api-ref.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../core/memory-management.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../api-ref.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
